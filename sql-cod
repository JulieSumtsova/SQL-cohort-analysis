with DIFF as 
    (
    select a.*,
            min(date_trunc('month', lesson_day)) over (partition by student_id) cohort,
            extract(year from age(date_trunc('month', lesson_day), min(date_trunc('month', lesson_day)) OVER (PARTITION BY STUDENT_ID)))*12 
             + extract(month from age(date_trunc('month', lesson_day), min(date_trunc('month', lesson_day)) OVER (PARTITION BY STUDENT_ID))) AS lt_month,
             lead(lesson_day) over (partition by student_id order by lesson_day),
        
            date_part('week', lesson_day) current_week,
            date_part('week', lead(lesson_day) over (partition by student_id order by lesson_day)) as next_week
    
    from test_lessons a),

table_2 as 
(
select DIFF.*, case when (next_week - current_week) < 0 then (next_week - current_week) + (select max(current_week) from DIFF where date_part('year', lesson_day) = 2020) - 1 else (next_week - current_week) -1 end difference_week
    from DIFF),
    
bad_students as    
(select cohort, lt_month, count(distinct student_id) as bad_students
from table_2
where DIFFERENCE_week > 1
group by  cohort, lt_month),

all_students as    
(select cohort, lt_month, count(distinct student_id) as all_students
from table_2
group by  cohort, lt_month)

select a.cohort, a.lt_month, all_students, bad_students, bad_students::float/all_students as dolya
from all_students a
left join bad_students b on a.cohort=b.cohort and a.lt_month=b.lt_month
